<!--
	Copyright 2013
	Ferret Renaud
	admin@ferretrenaud.com
-->

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="Author" content="FERRET Renaud" />
    <meta name="Description" content="Exercice de formation" />
    <meta name="copyright" content="(C) Copyright 2013 FERRET Renaud" />
    <meta name="distribution" content="global" />

    <title>Spring - Exercice 13 - JPA</title>

    <link
      href="./bootstrap-3.3.7-dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="./custom-css/custom.css" rel="stylesheet" />
    <!-- Ne pas voir les liens lors de l'impressions -->
    <style>
      @media print {
        a[href]:after {
          content: none;
        }
      }
    </style>

    <!--[if lt IE 9]>
      <script src="../bootstrap-3.3.7-dist/js/html5shiv.min.js"></script>
      <script src="../bootstrap-3.3.7-dist/js/respond.min.js"></script>
    <![endif]-->
  </head>

  <body class="container">
    <nav class="navbar navbar-default" id="top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle collapsed"
            data-toggle="collapse"
            data-target="#bs-example-navbar-collapse-1"
            aria-expanded="false"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" title="Spring - Exercice 12"
            >Spring E13</a
          >
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                role="button"
                aria-haspopup="true"
                aria-expanded="false"
                >1 - Installation<span class="caret"></span
              ></a>
              <ul class="dropdown-menu">
                <li>
                  <a href="#t11">1-1 Importation du projet dans Eclipse</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                role="button"
                aria-haspopup="true"
                aria-expanded="false"
                >2 - Transformation du projet<span class="caret"></span
              ></a>
              <ul class="dropdown-menu">
                <li><a href="#t21">2-1 Ajout du répertoire Spring</a></li>
                <li>
                  <a href="#t22">2-2 Création des fichiers pour Spring</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                role="button"
                aria-haspopup="true"
                aria-expanded="false"
                >3 - Modification des DAOs<span class="caret"></span
              ></a>
              <ul class="dropdown-menu">
                <li><a href="#t31">3-1 Modification du code Java</a></li>
                <li>
                  <a href="#t32">3-2 Déclaration dans le fichier Spring</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                role="button"
                aria-haspopup="true"
                aria-expanded="false"
                >4 - Modification des Services<span class="caret"></span
              ></a>
              <ul class="dropdown-menu">
                <li><a href="#t41">4-1 Modification du code Java</a></li>
                <li>
                  <a href="#t42">4-2 Déclaration dans le fichier Spring</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                role="button"
                aria-haspopup="true"
                aria-expanded="false"
                >5 - Modification du Main<span class="caret"></span
              ></a>
              <ul class="dropdown-menu">
                <li><a href="#t51">5-1 Modification du code Java</a></li>
                <li><a href="#t52">5-2 Test</a></li>
              </ul>
            </li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container-fluid -->
    </nav>
    <br />
    <div class="page-header">
      <h1>Spring - Exercice 13 - JPA</h1>
      <p>Spring et JPA.</p>
      <nav>
        <ul class="pager">
          <li class="previous" title="Hibernate">
            <a href="./Exo12-Hibernate.html"
              ><span aria-hidden="true">&larr;</span> Exercice Précédent</a
            >
          </li>
          <li class="next" title="Spring MVC">
            <a href="./Exo14-MVC.html"
              >Exercice Suivant <span aria-hidden="true">&rarr;</span></a
            >
          </li>
        </ul>
      </nav>
    </div>
    <!-- page header -->

    <section>
      <h2 id="t1"><span class="label label-default">1</span> Installation</h2>
      <div class="panel panel-default panel-primary" id="t11">
        <div class="panel-heading">
          <h3 class="panel-title">
            Importation du projet dans Eclipse
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Vous allez récupérer un nouveau projet qui fait exactement la même
            chose que l'ancien, mais en JPA 2.1 (faisant usage de
            l'implémentation Hibernate 5). Nous allons le lier à Spring
          </p>
          <p>Pour importer le projet :</p>
          <ul>
            <li>
              Dans le menu Eclipse, sélectionnez File/Import puis Existing Maven
              Projects
            </li>
            <li>Pointez vers l'un des projets dans l'énoncé.</li>
          </ul>
          <p>
            Important : Après toutes modifications faites sur le fichier
            pom.xml, faites un clic droit sur <b>votre projet</b> puis Maven -
            Update Project ...
          </p>
          <p>
            Vérifiez que tout compile (pas de [ERROR] dans la console Maven et
            un BUILD SUCCESS).
          </p>
          <p>
            Lancez le main pour voir ce qui se passe. Ajustez le login/password
            de la base de données si besoin, ils se trouvent dans le fichier
            META-INF/persistence.xml qui se trouve dans le répertoire de source
            src/main/resources.
          </p>
          <p>
            Rappel : Pour simplifier la manipulation, toutes les dépendances
            sont déjà dans le pom.xml.
          </p>
        </div>
      </div>
    </section>

    <section>
      <h2 id="t2">
        <span class="label label-default">2</span> Transformation du projet
      </h2>
      <div class="panel panel-default panel-primary" id="t21">
        <div class="panel-heading">
          <h3 class="panel-title">
            Ajout du répertoire Spring
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            S'il n'est pas déjà présent, ajoutez un répertoire à votre projet
            dans src\main\resources\ :
          </p>
          <ul>
            <li>
              Clic droit sur votre projet, puis Nouveau/Répertoire (folder).
            </li>
            <li>Appelez le <i>spring</i>.</li>
          </ul>
        </div>
      </div>
      <div class="panel panel-default panel-primary" id="t22">
        <div class="panel-heading">
          <h3 class="panel-title">
            Création des fichiers Spring
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Dans le répertoire <i>spring</i>, inspirez-vous des exercices
            précédents pour créer vos fichiers Spring.
          </p>
          <p>
            Créez un fichier properties, database.properties au niveau du
            répertoire spring. Sortez les informations du fichier
            META-INF/persistence.xml Ajustez si besoin votre login/password.
          </p>
          <pre>
# Informations classiques
db.driver=com.mysql.jdbc.Driver
db.url=jdbc:mysql://localhost/banque?useSSL=false
db.login=root
db.password=

# Informations pour JPA Hibernate
hibernate.dialect=<a href="https://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/dialect/MySQL5InnoDBDialect.html" target="_blank">org.hibernate.dialect.MySQL5InnoDBDialect</a>
hibernate.show_sql=false</pre>
        </div>
      </div>
    </section>

    <section>
      <h2 id="t3">
        <span class="label label-default">3</span> Modification des DAOs
      </h2>
      <div class="panel panel-default panel-primary" id="t31">
        <div class="panel-heading">
          <h3 class="panel-title">
            Modification du code Java
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Modifiez la classe AbstractDAO, ajoutez l'annotation
            <a
              href="http://docs.oracle.com/javaee/7/api/javax/persistence/PersistenceContext.html"
              target="_blank"
              >@PersistenceContext</a
            >
            sur l'attribut EntityManager.
          </p>
          <p>
            Supprimer de la classe et de son interface la méthode
            setEntityManager.
          </p>
          <p>Profitez en pour retirer aussi la méthode getEntityTransaction.</p>
          <p>
            Le Spring va se charger de l'entity manager, corriger l'impact dans
            les classes services et tests unitaires
          </p>
        </div>
      </div>

      <div class="panel panel-default panel-primary" id="t32">
        <div class="panel-heading">
          <h3 class="panel-title">
            Déclaration dans le fichier Spring
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Selon vos orientations (annotation ou déclaration), n'oubliez pas de
            déclarez les DAO et vos services métiers (dans un fichier
            data-context.xml et service-context.xml) ou via les annotations
            <a
              href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/stereotype/Service.html"
              target="_blank"
              >@Service</a
            >
            et
            <a
              href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/stereotype/Repository.html"
              target="_blank"
              >@Repository</a
            >.
          </p>
          <p>
            Si il n'existe pas, ajoutez un fichier data-context.xml, déclarez y
            votre data source, chargez y votre fichier properties (exactement
            comme en JDBC).
          </p>
          <p>
            Si il n'existe pas, ajoutez un fichier jpa-context.xml dans votre
            dossier Spring. Il contiendra la configuration JPA. L'idée est de
            déporter une partie des informations qui étaient dans le fichier
            persistence.xml.
          </p>
          <pre>
  ...
  &lt;bean id="entityManagerFactory" class="<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/orm/jpa/LocalContainerEntityManagerFactoryBean.html" target="_blank">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</a>"&gt;
    &lt;property name="jtaDataSource" ref="dataSource" /&gt;
    &lt;property name="jpaProperties"&gt;
      &lt;props&gt;
        &lt;prop key="hibernate.dialect"&gt;${hibernate.dialect}&lt;/prop&gt;
        &lt;prop key="hibernate.show_sql"&gt;${hibernate.show_sql}&lt;/prop&gt;
      &lt;/props&gt;
    &lt;/property&gt;
  &lt;/bean&gt;
  ...</pre>
          <p>
            Modifiez ensuite votre fichier META-INF/persistence.xml afin de
            retirer ce qui est maintenant à la charge du Spring.
          </p>
          <pre>
  ...
  &lt;persistence-unit name="JPABanque" transaction-type="RESOURCE_LOCAL"&gt;
    &lt;provider&gt;<a target="_blank" href="https://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/jpa/HibernatePersistenceProvider.html">org.hibernate.jpa.HibernatePersistenceProvider</a>&lt;/provider&gt;
    &lt;class&gt;com.banque.entity.impl.AbstractEntity&lt;/class&gt;
    &lt;class&gt;com.banque.entity.impl.UtilisateurEntity&lt;/class&gt;
    &lt;class&gt;com.banque.entity.impl.CompteEntity&lt;/class&gt;
    &lt;class&gt;com.banque.entity.impl.OperationEntity&lt;/class&gt;
  &lt;/persistence-unit&gt;
  ... </pre>
        </div>
      </div>
    </section>

    <section>
      <h2 id="t4">
        <span class="label label-default">4</span> Modification des Services
      </h2>
      <div class="panel panel-default panel-primary" id="t41">
        <div class="panel-heading">
          <h3 class="panel-title">
            Modification du code Java
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Ce sont les services qui instancient vos DAO, corrigez cela en
            laissant le spring faire, utilisez l'annotation
            <a
              href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/annotation/Autowired.html"
              >@Autowired</a
            >
            ou faites des fichiers Spring pour exprimer le lien entre chaque
            objet.
          </p>
          <p>Faites de même dans les tests unitaires.</p>
          <p>
            A la vue du code doit-on ajouter des contraintes transactionnelles
            ?.
          </p>
        </div>
      </div>

      <div class="panel panel-default panel-primary" id="t42">
        <div class="panel-heading">
          <h3 class="panel-title">
            Déclaration dans le fichier Spring
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Si vous n'avez pas opté pour les annotations, créez un fichier XML
            <b>service-context.xml</b>, sinon n'oubliez pas le
            context:component-scan
          </p>
          <p>
            Pour la remise en place du transactionnel, n'oubliez pas que
            contrairement au JDBC, le transactionManager sera de la classe
            <a
              href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/orm/jpa/JpaTransactionManager.html"
              target="_blank"
              >org.springframework.orm.jpa.JpaTransactionManager</a
            >.
          </p>
          <p>
            Notez aussi que ce dernier n'est plus lié à une DataSource mais à la
            entityManagerFactory que vous avez déclarée dans le fichier
            jpa-context.xml
          </p>
          <pre>
  ...
  &lt;bean id="transactionManager" class="<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/orm/jpa/JpaTransactionManager.html" target="_blank">org.springframework.orm.jpa.JpaTransactionManager</a>"&gt;
    &lt;property name="entityManagerFactory" ref="entityManagerFactory" /&gt;
  &lt;/bean&gt;
  ...</pre>
          <p>
            Pensez à replacer la mécanique transactionnelle dans vos services
            métiers, utilisez les aspects ou les annotations.
          </p>
        </div>
      </div>
    </section>

    <section>
      <h2 id="t5">
        <span class="label label-default">5</span> Modification du Main
      </h2>
      <div class="panel panel-default panel-primary" id="t51">
        <div class="panel-heading">
          <h3 class="panel-title">
            Modification du code Java
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>
            Editez votre classe com.banque.Main afin qu'elle charge vos fichiers
            Spring dans un contexte.
          </p>
          <pre>
ClassPathXmlApplicationContext appContext = null;
try {
  appContext = new ClassPathXmlApplicationContext("spring/*-context.xml");
  ...</pre
          >
          <p>Les fichiers seront chargés dans le même objet contexte.</p>
          <p>
            Au lieu d'instancier vos beans services, demandez au contexte spring
            de les récupérer. Donc plus de new XxxxService(), mais des appels à
            <b>appContext.getBean(...)</b> à la place. Il y a 3 getBean à
            mettre.
          </p>
          <p>Pensez à fermer votre contexte Spring quoi qu'il arrive.</p>
          <p>
            Faut-il conserver le chargement de l'EntityManager dans le main ?
          </p>
        </div>
      </div>

      <div class="panel panel-default panel-primary" id="t52">
        <div class="panel-heading">
          <h3 class="panel-title">
            Test
            <a href="#top"
              ><span
                class="glyphicon glyphicon-menu-up pull-right"
                title="Remonter"
              ></span
            ></a>
          </h3>
        </div>
        <div class="panel-body">
          <p>Ajustez les tests JUnit afin qu'ils utilisent le Spring.</p>
          <p>
            Lancez vos classes de test (ou même tous les packages de test) en
            tant que test JUnit (Run As - Junit Test) et regardez le résultat.
          </p>
          <p>
            Via Maven, lancez le goal test à partir du fichier pom.xml : clic
            droit, Run As - Maven Test
          </p>
          <p>
            Rappel : dans le cas des tests sur les <b>DAO</b>, il est
            indispensable (surtout dans le cas d'Hibernate ou JPA) de marquer
            l'annotation
            <a
              href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/annotation/Transactional.html"
              target="_blank"
              >@Transactional</a
            >
            (ou tout autre mécanique associée aux transactionnels) sur la classe
            (ou les méthodes) de test. Ce n'est pas utile dans le cas des
            services, car vos classes services sont, en principe, déjà marquées
            comme transactionnelles.
          </p>
        </div>
      </div>
    </section>

    <nav>
      <ul class="pager">
        <li class="previous" title="Hibernate">
          <a href="../Exo12-Hibernate/Exo12-Hibernate.html"
            ><span aria-hidden="true">&larr;</span> Exercice Précédent</a
          >
        </li>
        <li class="next" title="Spring MVC">
          <a href="../Exo14-MVC/Exo14-MVC.html"
            >Exercice Suivant <span aria-hidden="true">&rarr;</span></a
          >
        </li>
      </ul>
    </nav>

    <br /><br />
    <footer>
      <p class="text-center">
        <a href="http://validator.w3.org/">
          <img
            src="../bootstrap-3.3.7-dist/img/HTML5_Logo_32.png"
            alt="Valid HTML 5.0"
          /> </a
        ><br />
        Copyright <span class="glyphicon glyphicon-copyright-mark"></span>
        <a href="http://ferretrenaud.fr" target="_blank">Ferret Renaud</a> 2013
      </p>
    </footer>

    <script src="../bootstrap-3.3.7-dist/js/jquery.min.js"></script>
    <script src="../bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
  </body>
</html>
